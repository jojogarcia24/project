<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Elite Projects • Developments</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root{
      --bg:#0a0a0a; --panel:#1a1a1a; --glass:rgba(255,255,255,.08);
      --text:#e0e6f0; --muted:#aab8d0; --brand:#66b3ff; --accent:#00e6b8;
      --border:#2c2c2c; --glow-brand:rgba(102,179,255,.4); --glow-accent:rgba(0,230,184,.4);
      --shadow-dark:rgba(0,0,0,.6);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:'Inter',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6;scroll-behavior:smooth}
    a{color:var(--brand);text-decoration:none;transition:color .2s}
    a:hover{color:var(--accent)}

    /* Header (mobile-friendly) */
    .site-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 18px;position:sticky;top:0;z-index:100;background:linear-gradient(180deg,rgba(0,0,0,.95),rgba(0,0,0,.7) 60%,transparent)}
    .logo{height:50px}

    /* Hero */
    .hero{position:relative;height:50vh;min-height:380px;overflow:hidden;border-bottom:1px solid var(--border);display:flex;align-items:flex-end;padding:22px}
    .hero-bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:brightness(.65);animation:zoompan 35s infinite alternate ease-in-out}
    .hero-overlay{position:absolute;inset:0;background:radial-gradient(1000px 500px at 20% 20%,var(--glow-brand),transparent 70%),radial-gradient(1000px 500px at 80% 60%,var(--glow-accent),transparent 70%)}
    .hero-content{position:relative;z-index:5;text-shadow:0 4px 12px var(--shadow-dark)}
    .title-xl{font-size:clamp(24px,6vw,56px);font-family:'Orbitron',sans-serif;margin:0 0 6px}
    .subtitle{color:var(--muted);margin:0}
    .elite-badge{position:absolute;top:16px;right:16px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(0,0,0,.95)}
    .hidden{display:none}

    /* Layout */
    .layout{display:grid;grid-template-columns:340px 1fr;gap:22px;padding:20px;max-width:1400px;margin:0 auto}

    /* Cards */
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:20px}
    .card h3{margin:0 0 12px}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(8px)}

    /* Lists */
    .glance-list,.nearby-list{list-style:none;padding:0;margin:0}
    .glance-list li{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px dashed var(--border)}
    .glance-list li:last-child,.nearby-item:last-child{border-bottom:none}
    .nearby-item{padding:9px 0;border-bottom:1px dashed var(--border)}
    .nearby-item strong{display:block;color:var(--brand)}

    /* Gallery */
    .gallery-main-img{width:100%;height:440px;object-fit:cover;border-radius:14px;border:1px solid var(--border)}
    .gallery-thumbs{display:flex;gap:10px;overflow-x:auto;padding:8px 0}
    .thumb{flex:0 0 120px;height:82px;border-radius:10px;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}

    /* Agent/Builder cards – mobile safety */
    .card-container{display:flex;flex-wrap:wrap;gap:16px}
    .agent-card,.builder-card{flex:1 1 320px;min-width:280px}
    .agent-top{display:flex;gap:12px;align-items:center}
    .agent-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid var(--brand)}
    .agent-name{font-weight:600}
    .agent-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .icon-btn{display:inline-flex;align-items:center;gap:6px;padding:9px 12px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.06)}
    .about-line{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .agent-card p,.builder-card p{overflow-wrap:anywhere}

    /* Map */
    .map{height:400px;border-radius:14px;border:1px solid var(--border);width:100%}

    /* Embeds */
    .media-section h3{margin:14px 0}
    .matterport-grid{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:18px}
    .embed{position:relative;padding-top:56.25%;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
    .embed iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

    /* Footer */
    footer{border-top:1px solid var(--border);padding:32px 20px;background:#000;color:#aab8d0}

    /* Responsive fixes */
    @media (max-width:980px){
      .layout{grid-template-columns:1fr;padding:16px}
      .hero{height:42vh;min-height:300px;padding:18px}
      .gallery-main-img{height:320px}
    }
    @media (max-width:768px){
      .matterport-grid{grid-template-columns:1fr}
      .map{height:320px}
      .icon-btn{flex:1 1 100px;justify-content:center}
    }

    @keyframes zoompan{0%{transform:scale(1.05)}100%{transform:scale(1.15)}}
  </style>
</head>
<body>
  <header class="site-header">
    <img src="https://secure.elitelivingconnect.com/file/99d90d48c89a9816deebf6f27b7c39f3/a78ceb63-699f-420d-bfd7-d2e1997e1f58/New+Elite+Living+Realty+Logo+White.png" alt="Elite Living Realty" class="logo" />
    <nav class="main-nav">
      <a href="/">Home</a>
      <a href="/?project=">Search Projects</a>
    </nav>
  </header>

  <section id="hero" class="hero">
    <div id="heroBg" class="hero-bg"></div>
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1 id="projectName" class="title-xl"></h1>
      <p id="projectAddress" class="subtitle"></p>
    </div>
    <div id="eliteBadge" class="elite-badge hidden">Elite Signature</div>
  </section>

  <main id="main" class="layout">
    <aside class="sidebar">
      <div class="card glass">
        <h3>At a Glance</h3>
        <ul id="glanceList" class="glance-list"></ul>
      </div>

      <div class="card">
        <h3>About This Home</h3>
        <div id="aboutFull"></div>
      </div>

      <div class="card glass">
        <h3>Nearby Amenities</h3>
        <ul id="nearbyList" class="nearby-list"></ul>
      </div>

      <div class="card glass">
        <h3>Nearby Schools</h3>
        <ul id="schoolsList" class="nearby-list"></ul>
      </div>
    </aside>

    <section class="content">
      <section class="card">
        <h3>Photo Gallery</h3>
        <img id="mainGalleryImg" class="gallery-main-img" alt="Main gallery image" />
        <div id="galleryThumbs" class="gallery-thumbs"></div>
      </section>

      <div class="card">
        <h3>Listing Agents</h3>
        <div id="agentCards" class="card-container"></div>
      </div>

      <!-- NEW: Highlights & Amenities -->
      <div class="card" id="highlightsCard" style="display:none;">
        <h3>Highlights &amp; Amenities</h3>
        <div id="highlightsAmenitiesContent"></div>
      </div>

      <div class="card">
        <h3>Map</h3>
        <div id="map" class="map"></div>
      </div>

      <div class="card">
        <h3>Builder</h3>
        <div id="builderCards" class="card-container"></div>
      </div>

      <div id="mediaEmbeds" class="media-section"></div>
    </section>
  </main>

  <!-- Agent / Builder / About modals -->
  <div id="aboutModal" class="modal" hidden></div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" hidden></div>

  <footer class="legal-footer">
    <div class="legal-updated" style="text-align:center">Updated September 2025</div>
  </footer>

  <script>
    /* ---------- Helpers ---------- */
    function asText(v){
      if(v==null) return "";
      if(typeof v==="string") return v;
      if(Array.isArray(v)) return v.map(x=>asText(x)).join(", ");
      if(typeof v==="object"){
        if("name" in v) return String(v.name);
        if("text" in v) return String(v.text);
        try{ return JSON.stringify(v) }catch(e){ return String(v) }
      }
      return String(v);
    }
    function splitCSV(s){return asText(s).split(',').map(t=>t.trim()).filter(Boolean)}
    function bulletsFrom(s){
      const raw=asText(s).trim();
      if(!raw) return [];
      if(/\n/.test(raw)) return raw.split(/\n+/).map(x=>x.replace(/^[-•·]\s*/,'').trim()).filter(Boolean);
      if(/•|·|;|,/.test(raw)) return raw.split(/•|·|;|,/).map(x=>x.trim()).filter(Boolean);
      return []; // not bullet-y
    }
    function looksLikeRecordId(val){return /^rec[a-z0-9]{14,}$/i.test(val.trim())}

    /* ---------- Map + Nearby ---------- */
    function haversine(a,b,c,d){const R=3958.8,φ1=a*Math.PI/180,φ2=c*Math.PI/180,Δφ=(c-a)*Math.PI/180,Δλ=(d-b)*Math.PI/180;const x=Math.sin(Δφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)))}
    function searchAndDisplayAmenities(p,listId,types,title){
      const list=document.getElementById(listId);
      list.innerHTML='<li class="nearby-item"><small>Searching for nearby '+title.toLowerCase()+'...</small></li>';
      if(!p.Latitude||!p.Longitude){list.innerHTML='<li class="nearby-item"><small>Location not available.</small></li>';return}
      const q=`[out:json][timeout:25];(node["amenity"~"${types}"](around:2000,${p.Latitude},${p.Longitude});way["amenity"~"${types}"](around:2000,${p.Latitude},${p.Longitude});relation["amenity"~"${types}"](around:2000,${p.Latitude},${p.Longitude}););out center 20;`;
      fetch('https://overpass-api.de/api/interpreter',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},body:'data='+encodeURIComponent(q)})
      .then(r=>r.json()).then(data=>{
        list.innerHTML='';
        if(!data.elements?.length){list.innerHTML='<li class="nearby-item"><small>No results.</small></li>';return}
        const seen=new Set();
        data.elements.forEach(el=>{
          const nm=el.tags?.name; if(!nm||seen.has(nm)) return; seen.add(nm);
          const lat=el.lat||(el.center&&el.center.lat),lon=el.lon||(el.center&&el.center.lon);
          const dist=lat&&lon?haversine(p.Latitude,p.Longitude,lat,lon).toFixed(1):'N/A';
          const li=document.createElement('li'); li.className='nearby-item';
          li.innerHTML=`<strong>${nm}</strong><p>${dist} miles</p><small>${(el.tags?.amenity||'place').replace('_',' ')}</small>`;
          list.appendChild(li);
        });
      }).catch(()=>{list.innerHTML='<li class="nearby-item"><small>Failed to load nearby data.</small></li>'});
    }
    function initMapLeaflet(p){
      const el=document.getElementById('map');
      if(!p.Latitude||!p.Longitude){el.innerHTML='<div style="padding:20px;text-align:center;color:#aab8d0">Location not available.</div>';return}
      const map=L.map(el,{scrollWheelZoom:false}).setView([p.Latitude,p.Longitude],14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      L.marker([p.Latitude,p.Longitude]).addTo(map).bindPopup(`<b>${asText(p['Project Name'])||'Project'}</b><br>${asText(p.Address)}`).openPopup();
      searchAndDisplayAmenities(p,'nearbyList','restaurant|hospital|cafe|bar|park|supermarket|pharmacy|bank|fitness_centre','amenities');
      searchAndDisplayAmenities(p,'schoolsList','school','schools');
    }

    /* ---------- Populate UI ---------- */
    function populate(p){
      // Hero
      const hero=document.getElementById('heroBg');
      const heroSrc=asText(p.HeroImageURL)||splitCSV(p.GalleryURLsCSV)[0]||'';
      if(heroSrc) hero.style.backgroundImage=`url('${heroSrc}')`;
      document.getElementById('projectName').textContent=asText(p['Project Name'])||'New Development';
      document.getElementById('projectAddress').textContent=asText(p.Address)||'';

      const price=Number(String(asText(p['Listing Price'])).replace(/[^0-9.]/g,'')); 
      if(price>1000000) document.getElementById('eliteBadge').classList.remove('hidden');

      // At a Glance
      const gl=document.getElementById('glanceList'); gl.innerHTML='';
      const fmtPrice=isFinite(price)?new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(price):'N/A';
      const comp=p['Estimated Completion']?new Date(asText(p['Estimated Completion'])).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}):'N/A';
      [['Status',p.Status],['Price',fmtPrice],['Beds',p.Beds],['Baths',p.Baths],['Sq Footage',p['Sq Footage']?`${asText(p['Sq Footage'])} sq ft`:'' ],['Estimated Completion',comp]].forEach(([k,v])=>{
        if(asText(v)){const li=document.createElement('li');li.innerHTML=`<span>${k}</span><span>${asText(v)}</span>`;gl.appendChild(li)}
      });
      if(asText(p['Site Plans'])){const li=document.createElement('li');li.innerHTML=`<span>Site Plan</span><a class="icon-btn" href="${asText(p['Site Plans'])}" target="_blank">View Plan</a>`;gl.appendChild(li)}

      // About Home
      const about=asText(p.Description)||'No description available.';
      document.getElementById('aboutFull').innerHTML=`<p class="about-line">${about}</p>`;

      // Gallery
      const imgs=splitCSV(p.GalleryURLsCSV); const main=document.getElementById('mainGalleryImg'); const thumbs=document.getElementById('galleryThumbs');
      if(imgs.length){main.src=imgs[0];}else{main.src='https://via.placeholder.com/800x450?text=No+Images'}
      thumbs.innerHTML=''; imgs.forEach((src,i)=>{const t=document.createElement('div');t.className='thumb';t.innerHTML=`<img src="${src}" alt="thumb ${i+1}">`;t.onclick=()=>{main.src=src};thumbs.appendChild(t)});

      // Builder
      const bNames=splitCSV(p['Builder Owners']); const bPhotos=splitCSV(p['Builder Photo']); const bTitles=splitCSV(p['Builder Owner Titles']);
      const builderWrap=document.getElementById('builderCards'); builderWrap.innerHTML='';
      if(!bNames.length) builderWrap.innerHTML='<p style="color:#aab8d0">Builder information not available.</p>';
      bNames.forEach((name,i)=>{const photo=bPhotos[i]||'https://via.placeholder.com/150/1a1a1a/e0e6f0?text=Builder';const title=bTitles[i]||'Builder';
        builderWrap.innerHTML+=`
          <div class="card builder-card">
            <div class="agent-top">
              <img class="agent-avatar" src="${photo}" alt="${name}">
              <div><div class="agent-name">${name}</div><div class="agent-tag">${title}</div></div>
            </div>
            <p class="about-line">Meet ${name}, a dedicated builder with expertise in ${title}.</p>
          </div>`});

      // Agents (names from Listing Agent 2; if rec IDs, fallback to other name fields)
      let agentNames=splitCSV(p['Listing Agent 2']);
      if(agentNames.some(n=>looksLikeRecordId(n))){
        const fallback = splitCSV(p['Agent Names']).length ? splitCSV(p['Agent Names'])
                      : splitCSV(p['Agent Name']).length ? splitCSV(p['Agent Name'])
                      : (asText(p['Agent 1 Name'])||asText(p['Agent One Name'])||asText(p['Agent Name 1'])||'') + ',' + (asText(p['Agent 2 Name'])||asText(p['Agent Two Name'])||asText(p['Agent Name 2'])||'');
        agentNames = splitCSV(fallback.length?fallback:agentNames);
      }
      const agentPhotos=splitCSV(p['Agent Photo']); const agentEmails=splitCSV(p['Agent Email']); const agentPhones=splitCSV(p['Agent Phone Number']); const agentTitles=splitCSV(p['Agent Title']);
      const about1=asText(p['About Agent 1'])||asText(p['Agent 1 About']); const about2=asText(p['About Agent 2'])||asText(p['Agent 2 About']); 
      let parts = [about1,about2].filter(Boolean);
      if(!parts.length){
        const combo=asText(p['About Agent']);
        if(combo.includes('||')) parts=combo.split('||'); else if(/\n-{3,}\n/.test(combo)) parts=combo.split(/\n-{3,}\n/); else if(/\n\n+/.test(combo)) parts=combo.split(/\n\n+/); else if(combo) parts=[combo];
      }
      const agentWrap=document.getElementById('agentCards'); agentWrap.innerHTML='';
      if(!agentNames.length) agentWrap.innerHTML='<p style="color:#aab8d0">Agent information not available.</p>';
      agentNames.forEach((name,i)=>{
        const tel=(agentPhones[i]||'').replace(/[^0-9+]/g,''); const email=agentEmails[i]||''; const title=agentTitles[i]||'Real Estate Agent';
        const bio=(parts[i]||parts[0]||'No detailed bio available.'); const firstDot=bio.indexOf('.'); const excerpt=firstDot>=0?bio.slice(0,firstDot+1):bio;
        const photo=agentPhotos[i]||'https://via.placeholder.com/150/1a1a1a/e0e6f0?text=Agent';
        agentWrap.innerHTML+=`
          <div class="card agent-card">
            <div class="agent-top">
              <img class="agent-avatar" src="${photo}" alt="${name}">
              <div><div class="agent-name">${name}</div><div class="agent-tag">${title}</div></div>
            </div>
            <p class="about-line">${excerpt}</p>
            <div class="agent-actions">
              ${tel?`<a class="icon-btn" href="tel:${tel}">📞 Call</a>`:''}
              ${tel?`<a class="icon-btn" href="sms:${tel}">💬 Text</a>`:''}
              ${email?`<a class="icon-btn" href="mailto:${email}">✉️ Email</a>`:''}
            </div>
          </div>`;
      });

      // Highlights & Amenities (always render if non-empty)
      const hiRaw=asText(p['Highlights']); const amRaw=asText(p['Amenities']);
      const hiBul=bulletsFrom(hiRaw); const amBul=bulletsFrom(amRaw);
      if(hiRaw || amRaw){
        const wrap=document.getElementById('highlightsCard'); const content=document.getElementById('highlightsAmenitiesContent'); let html='';
        if(hiBul.length){ html+=`<h4>Highlights</h4><ul>${hiBul.map(x=>`<li>${x}</li>`).join('')}</ul>` } else if(hiRaw){ html+=`<h4>Highlights</h4><p>${hiRaw}</p>` }
        if(amBul.length){ html+=`<h4>Amenities</h4><ul>${amBul.map(x=>`<li>${x}</li>`).join('')}</ul>` } else if(amRaw){ html+=`<h4>Amenities</h4><p>${amRaw}</p>` }
        content.innerHTML=html; wrap.style.display='';
      }

      // Media (two Matterports side-by-side, video below)
      const media=document.getElementById('mediaEmbeds'); media.innerHTML='';
      const pre=asText(p['Pre Dry Wall Matterport']); const fin=asText(p['Final Matterport']); const vid=asText(p['Marketing Video']);
      const blocks=[];
      if(pre){blocks.push(`<div class="card"><h3>Pre Dry Wall Matterport</h3><div class="embed"><iframe src="${pre}" allowfullscreen></iframe></div></div>`)}
      if(fin){blocks.push(`<div class="card"><h3>Final Matterport</h3><div class="embed"><iframe src="${fin}" allowfullscreen></iframe></div></div>`)}
      if(blocks.length){media.innerHTML+=`<h3>Virtual Tours</h3><div class="matterport-grid">${blocks.join('')}</div>`}
      if(vid){media.innerHTML+=`<h3>Video Tour</h3><div class="card"><div class="embed"><iframe src="${vid}" allowfullscreen></iframe></div></div>`}

      // Map last
      initMapLeaflet(p);
    }

    /* ---------- Fetch from Netlify Function ---------- */
    async function fetchProject(slug){
      const res=await fetch(`/.netlify/functions/project?slug=${encodeURIComponent(slug)}`);
      if(!res.ok) throw new Error(`API error ${res.status}`);
      const data=await res.json();
      if(!data?.project) throw new Error("Project not found");
      return data.project;
    }

    /* ---------- Boot ---------- */
    window.addEventListener('DOMContentLoaded',async()=>{
      try{
        const params=new URLSearchParams(location.search);
        const slug=asText(params.get("project")).trim();
        if(!slug) throw new Error("Missing ?project= slug in URL");
        const project=await fetchProject(slug);
        populate(project);
      }catch(e){
        console.error(e);
        document.getElementById('main').innerHTML=`<div class="card" style="text-align:center"><h3>Oops!</h3><p>${e.message}</p><a href="/" class="icon-btn">Go Home</a></div>`;
      }
    });
  </script>

  <!-- LeadConnector Chat -->
  <script>
    (function(){
      window.LC_API=window.LC_API||{};
      window.LC_API.on_after_load=function(){ if(window.LC_API?.open_chat) window.LC_API.open_chat(); };
      var s=document.createElement("script"); s.src="https://beta.leadconnectorhq.com/loader.js"; s.async=true;
      s.setAttribute("data-resources-url","https://beta.leadconnectorhq.com/chat-widget/loader.js");
      s.setAttribute("data-widget-id","68ae95eb6d8a7f8237ababc5");
      document.body.appendChild(s);
    })();
  </script>
</body>
</html>
